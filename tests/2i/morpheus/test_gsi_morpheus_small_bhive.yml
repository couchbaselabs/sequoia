- include: tests/templates/kv.yml, tests/templates/n1ql.yml, tests/templates/rebalance.yml, tests/templates/multinode_failure.yml, tests/templates/bucket.yml

############### Sleep for 5 mins before changing indexer settings ################
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "300"
  requires: "{{eq true .DoOnce }}"
  wait: true

############### Enable Plasma Bloom Filter ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.plasma.backIndex.enablePageBloomFilter':true"
  requires: "{{eq true .DoOnce }}"

############### Enable breakpad ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.bhive.enableBreakPad':true"
  requires:  "{{eq true .DoOnce }}"


############### Set num_replica ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.num_replica':1"
  requires: "{{eq true .DoOnce }}"

############### Turn off reranking ################
# - template: set_gsi_config
#   args: "{{.ActiveIndexNode 0}}, 'indexer.scan.vector.rerank_factor':0"
#   requires: "{{eq true .DoOnce }}"

################ temporary settings MB-63703 and MB-63643 ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.numSliceWriters':4"
  requires: "{{eq true .DoOnce }}"

# - template: set_gsi_config
#   args: "{{.ActiveIndexNode 0}}, 'indexer.plasma.mainIndex.enableInMemoryCompression':false"
#   requires: "{{eq true .DoOnce }}"

## Enable file-based rebalance
############### shardAffinity ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.enable_shard_affinity':true"
  requires: "{{eq true .DoOnce }}"

## Enable file-based rebalance
############### shardAffinity ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.provisioned.enable_shard_affinity':true"
  requires: "{{eq true .DoOnce }}"

############### Backup any corrupted index data files ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.enable_corrupt_index_backup':true"
  requires: "{{eq true .DoOnce }}"

############### Disable workaround for MB-46650 ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.plasma.recovery.enableFullReplayOnError':false"
  requires: "{{eq true .DoOnce }}"

############### Enable GSI Redistribution of indexes on rebalance in ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.rebalance.redistribute_indexes':true"
  requires: "{{eq true .DoOnce }}"


############### Enable AWR and AUS ################
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action set_awr_aus --bucket_list {{.NthBucket 10}}"

############### create scopes and collections across 3 buckets as scope_1,scope_2 ... ###############
- image: sequoiatools/collections:1.0
  command: "-i {{.Orchestrator}}:8091 -b {{.Bucket}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=1 --collection_count=1 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "-i {{.Orchestrator}}:8091 -b {{.NthBucket 1}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=1 --collection_count=1 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "-i {{.Orchestrator}}:8091 -b {{.NthBucket 2}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=3 --collection_count=15 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "-i {{.Orchestrator}}:8091 -b {{.NthBucket 3}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=1 --collection_count=1 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "-i {{.Orchestrator}}:8091 -b {{.NthBucket 4}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=1 --collection_count=1 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "-i {{.Orchestrator}}:8091 -b {{.NthBucket 9}} -o create_multi_scope_collection -s scope_ -c coll_ --scope_count=1 --collection_count=1 --collection_distribution=uniform"
  requires: "{{eq true .DoOnce }}"
  wait: true

# Sleep for some time to allow collections manifest to sync
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "300"
  requires: "{{eq true .DoOnce }}"
  wait: true

############### initial data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 0  --end 10000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 0  --end 10000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############### data loading shoes dataset ################
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 8}} --start 0  --end 50000000 --sift_path /root/bigann/ --all_coll true"
  volumes: "/data/bigann/:/root/bigann"
  requires: "{{eq true .DoOnce }}"

- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 5}} --start 0  --end 50000000 --sift_path /root/bigann/ --all_coll true"
  volumes: "/data/bigann/:/root/bigann"
  requires: "{{eq true .DoOnce }}"

###############  create indexes ################
- section_start: create_replica_indexes

###############  Indexer Random Recovery ################
# TODO: Enable this after MB-65104 is fixed
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a random_recovery --timeout {{.Scale 3600}} --interval 300"
  alias: random_recovery

###############  build all deferred indexes ################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a build_deferred_index -m 5"
  wait: true


# Enable CBO and Update Statistics for indexes on some collections
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a enable_cbo --cbo_enable_ratio=50"
  alias: cbo_bucket1

# Sleep for some time to allow update statistics to run
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "60"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a enable_cbo --cbo_enable_ratio=50"
  alias: cbo_bucket2

# Sleep for some time to allow update statistics to run
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "60"
  wait: true

# Sleep for some time to allow update statistics to run
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

# Create N1QL UDF Library and function - do it once per test
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a create_n1ql_udf --lib_filename n1ql_udf.js --lib_name n1qludf"
  requires: "{{eq true .DoOnce }}"

############### incremental data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 10000  --end 1000000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 10000  --end 1000000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 3}} --start 10000  --end 1000000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

############ upsert vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 3}} --start 1 --end 10000 --batch_size 1000 --file_path /sift_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 3}} --start 1 --end 10000 --batch_size 1000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4

############ wait for a while ################
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false"
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"

############ wait for a while ################
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3600"
  wait: true

- client:
    op: rm
    container: vector_mutations_1
- client:
    op: rm
    container: vector_mutations_9
- client:
    op: rm
    container: vector_mutations_3
- client:
    op: rm
    container: vector_mutations_4
- client:
    op: rm
    container: vector_mutations_5
- client:
    op: rm
    container: vector_mutations_6
- client:
    op: rm
    container: vector_mutations_7
- client:
    op: rm
    container: vector_mutations_10

###############  create vector indexes ################
##### bucket2, bucket4, bucket5 both BHIVE and composite. bucket6 default is composite. bucket9 is BHIVE
- section_start: create_replica_indexes
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.Bucket}}  -a create_n_indexes_on_buckets --timeout 30 --num_of_indexes_per_bucket 4  --create_bhive_indexes true --num_dimensions 128 --skip_default_collection false --num_vectors 1000000 --distance_algo EUCLIDEAN_SQUARED --use_description IVF,PQ8x8"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 1}}  -a create_n_indexes_on_buckets --timeout 30  -v --num_of_indexes_per_bucket 4  --create_bhive_indexes true --num_dimensions 960 --skip_default_collection false --num_vectors 1000000 --distance_algo DOT --use_description IVF,PQ32x4FS"
  wait: true
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.Bucket}}  -a create_n_indexes_on_buckets --timeout 30 --num_of_indexes_per_bucket 4  --create_bhive_indexes true --num_dimensions 128 --skip_default_collection false --num_vectors 1000000 --distance_algo EUCLIDEAN_SQUARED --use_description IVF,PQ64x8"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 1}}  -a create_n_indexes_on_buckets --timeout 30  -v --num_of_indexes_per_bucket 4  --create_bhive_indexes true --num_dimensions 960 --skip_default_collection false --num_vectors 1000000 --distance_algo DOT"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 8}}  -a create_n_indexes_on_buckets --timeout 30  -v --num_of_indexes_per_bucket 4  --create_bhive_indexes true  --dataset shoes --num_dimensions 128 --skip_default_collection false --num_vectors 50000000 --distance_algo L2 --defer_build true --set_max_replicas 1 --use_description IVF,PQ64x8"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 5}}  -a create_n_indexes_on_buckets --timeout 30  -v --num_of_indexes_per_bucket 4  --create_bhive_indexes true  --dataset shoes --num_dimensions 128 --skip_default_collection false --num_vectors 50000000 --distance_algo L2 --defer_build true --set_max_replicas 1 --use_description IVF,SQ8"
  wait: true

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "602"
  wait: true

- client:
    op: rm
    container: random_recovery

## indexes on bucket4 and bucket5

###############  build all deferred indexes ################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a build_deferred_index -m 5"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a build_deferred_index -m 5"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a build_deferred_index -m 5"
  wait: true

############### Kill memcached ################
  template: kill_process
  args: "{{.NthDataNode 3}}, memcached"


# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "212"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a build_deferred_index -m 5"
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 2}}, memcached"

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1923"
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 1}}, memcached"


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a build_deferred_index -m 5"
  wait: true

# Wait till all indexes are completely built
- image: sequoiatools/wait_for_idx_build_complete
  command: "{{.ActiveIndexNode 0}} {{.RestUsername}} {{.RestPassword}}"
  wait: true

######## Validate items count against KV #######################

######## Validate items count against KV #######################
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --sample_size 5 --all_docs_indexed true --xattrs true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --sample_size 5 --all_docs_indexed true --xattrs true"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.Bucket}},{{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a post_topology_change_validations"
  wait: true

- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 10000  --end 2000000 --doc_template Hotel --all_coll true --expiry_mode true --max_ttl 21600 --percentage_expiry 10"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 10000  --end 1500000 --doc_template Hotel --all_coll true --expiry_mode true --max_ttl 36000 --percentage_expiry 5"
  requires: "{{eq true .DoOnce }}"

# - image: sequoiatools/query_manager:dev
#   command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action data_validation --use_sdk true --query_type n1ql --bucket_list  {{.NthBucket 1}}  --use_tls false --skip_default false"
#   wait: true


# ###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

# ############## Random index lifecycle actions on bucket 4 & 5 ###############
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1

- section_end: query_replica_indexes

############### Stop Collections CRUD and index creation on bucket4 & bucket5 ###############
- client:
    op: rm
    container: index_loop1
- client:
    op: rm
    container: index_loop2
- client:
    op: rm
    container: index_drop_loop1
- client:
    op: rm
    container: index_drop_loop2
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3600"
  wait: true

############### Flush Bucket ################ once ready repeat this for other buckets at different places
- template: flush-bucket
  args: "{{.NthBucket 1}}"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "124"
  wait: true

############ Repopulate flushed bucket ################

- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 0  --end 1000000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "273"
  wait: true

- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false"
  alias: vector_mutations_flush_1
  wait: true

- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_flush_2
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "173"
  wait: true

- client:
    op: rm
    container: vector_mutations_flush_1

- client:
    op: rm
    container: vector_mutations_flush_2

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

######## Validate items count against KV #######################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed false"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --sample_size 5 --all_docs_indexed true --xattrs true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --sample_size 5 --all_docs_indexed true --xattrs true"
  wait: true

- section_start: change_indexer_topologies
###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Rebalance-in single index node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "113"
  wait: true

############### Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "430"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some more time after indexer-kill completes (10 minutes)
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Complete the rebalance ################
- template: rebalance

- template: wait_for_rebalance
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1000000  --end 1010000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1000000  --end 1010000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true


############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1000001 --end 1010000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1000001 --end 1010000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1000001 --end 1010000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1000001 --end 1010000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r
  wait: true

- client:
    op: rm
    container: vector_mutations_1r
- client:
    op: rm
    container: vector_mutations_2r
- client:
    op: rm
    container: vector_mutations_3r
- client:
    op: rm
    container: vector_mutations_4r
- client:
    op: rm
    container: vector_mutations_5r
- client:
    op: rm
    container: vector_mutations_6r
- client:
    op: rm
    container: vector_mutations_7r
- client:
    op: rm
    container: vector_mutations_8r




######## Validate items count against KV #######################
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  alias: vector_mutations_1b
  requires: "{{eq true .DoOnce }}"

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1


###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true


###############  Rebalance-out single node ################
- template: rebalance_out
  args: "{{.ActiveIndexNode 0}}"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "101"
  wait: true

############## Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "440"
  wait: true

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1010000  --end 1020000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1010000  --end 102000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1010001 --end 1020000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1010001 --end 1020000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1010001 --end 1020000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1010001 --end 1020000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r2
  wait: true

- client:
    op: rm
    container: vector_mutations_1r2
- client:
    op: rm
    container: vector_mutations_2r2
- client:
    op: rm
    container: vector_mutations_3r2
- client:
    op: rm
    container: vector_mutations_4r2
- client:
    op: rm
    container: vector_mutations_5r2
- client:
    op: rm
    container: vector_mutations_6r2
- client:
    op: rm
    container: vector_mutations_7r2
- client:
    op: rm
    container: vector_mutations_8r2

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1

######## Validations #######################
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a post_topology_change_validations"
  wait: true


###############  Rebalance-out single index node and stop rebalance ################
- template: rebalance_out
  args: "{{.ActiveIndexNode 0}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "324"
  wait: true

- template: rebalance_stop

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "326"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

- template: rebalance

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --mutate true --mutation_duration 3600"
  alias: vector_mutations_1a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_4a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"



- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Rebalance-out single node ################
- template: rebalance_out
  args: "{{.ActiveIndexNode 0}}"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "330"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "901"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1

###############  Swap single index node ################
- template: rebalance_swap
  args: "{{.InActiveNode}}, {{.ActiveIndexNode 0}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "109"
  wait: true

############### Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "903"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true


###############  Complete the rebalance ################
- template: rebalance

- template: wait_for_rebalance
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 2}}, memcached"

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "612"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Rebalance-in 2 nodes one after another ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "330"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "901"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

###############  Rebalance-in single node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "330"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "901"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1


###############  Rebalance-out two index nodes ################
- template: rebalance_out
  args: "({{.ActiveIndexNode 0}},{{.ActiveIndexNode 2}})"

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "432"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "611"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --mutate true --mutation_duration 3600"
  alias: vector_mutations_1a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_4a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"

###############  Rebalance-in two index nodes ################
- template: add_node
  args: "{{.NthInActiveNode 0}}, index"
- args: "{{.NthInActiveNode 1}}, index"
- template: rebalance

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "417"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "619"
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1020000  --end 1030000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1020000  --end 1030000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1020001 --end 1030000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1020001 --end 1030000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1020001 --end 1030000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1020001 --end 1030000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r3
  wait: true


- client:
    op: rm
    container: vector_mutations_1r3
- client:
    op: rm
    container: vector_mutations_2r3
- client:
    op: rm
    container: vector_mutations_3r3
- client:
    op: rm
    container: vector_mutations_4r3
- client:
    op: rm
    container: vector_mutations_5r3
- client:
    op: rm
    container: vector_mutations_6r3
- client:
    op: rm
    container: vector_mutations_7r3
- client:
    op: rm
    container: vector_mutations_8r3

######## Validate items count against KV #######################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

############## Kill projector ################
- template: kill_process
  args: "{{.NthDataNode 0}}, projector"

# Sleep for some more time after projector-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "605"
  wait: true

############## Kill query ################
- template: kill_process
  args: "{{.Nodes | .Service `n1ql` | net 1}}, cbq-engine"

# Sleep for some more time after query-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "391"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"
  wait: true

###############  Rebalance out data node ################
- template: rebalance_out
  args: "({{.NthDataNode 1}})"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "298"
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 2}}, memcached"

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "614"
  wait: true

###############  Add back data node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, data"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "315"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "439"
  wait: true

# Sleep for some more time after indexer-kill completes (30 minutes)
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Failover and addback ################
- template: failover_force_and_recover
  args: "{{.ActiveIndexNode 2}}, full"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "304"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} --bucket_list {{.NthBucket 3}} -i {{.Scale 1}} -a random_index_lifecycle --skip_default_collection false -c False --interval 3600 --timeout 3600 -b {{.NthBucket 3}} --create_bhive_indexes true"
  alias: lifecycle1

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "3900"
  wait: true

- client:
    op: rm
    container: lifecycle1

############## Kill query ################
- template: kill_process
  args: "{{.Nodes | .Service `n1ql` | net 0}}, cbq-engine"

# Sleep for some more time after query-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "312"
  wait: true

############## Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

###############  Failover and rebalance out ################
- template: hard_failover_node
  args: "{{.ActiveIndexNode 1}}"
  wait: true

- template: rebalance
  wait: true

# Sleep for some time to allow DDL to complete if running in background.
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "299"
  wait: true

###############  Add back index node  ################
- template: add_node
  args: "{{.NthInActiveNode 0}}, index"
  wait: true

- template: rebalance
  wait: true
# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "289"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"
  wait: true

- section_end: change_indexer_topologies

## TODO Uncomment once DCP rebalance training issue is fixed
# Disable file-based rebalance
############### shardAffinity ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.enable_shard_affinity':false"
  requires: "{{eq true .DoOnce }}"

## Disable file-based rebalance
############### shardAffinity ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.provisioned.enable_shard_affinity':false"
  requires: "{{eq true .DoOnce }}"

############### Set transferBatchSize to 3 * number of indexer nodes ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.rebalance.transferBatchSize':12"
  requires: "{{eq true .DoOnce }}"

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "309"
  wait: true

- section_start: change_indexer_topologies_file_based

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

###############  Rebalance-in single index node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "310"
  wait: true

############### Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "430"
  wait: true

- template: wait_for_rebalance
  wait: true

# Sleep for some more time after indexer-kill completes (10 minutes)
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Complete the rebalance ################
- template: rebalance

- template: wait_for_rebalance
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1030000  --end 1040000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1030000  --end 1040000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true


############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1030001 --end 1040000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1030001 --end 1040000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1030001 --end 1040000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1030001 --end 1040000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r
  wait: true

- client:
    op: rm
    container: vector_mutations_1r
- client:
    op: rm
    container: vector_mutations_2r
- client:
    op: rm
    container: vector_mutations_3r
- client:
    op: rm
    container: vector_mutations_4r
- client:
    op: rm
    container: vector_mutations_5r
- client:
    op: rm
    container: vector_mutations_6r
- client:
    op: rm
    container: vector_mutations_7r
- client:
    op: rm
    container: vector_mutations_8r

######## Validate items count against KV #######################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --mutate true --mutation_duration 3600"
  alias: vector_mutations_1a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_4a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Rebalance-out single index node ################
- template: rebalance_out
  args: "{{.ActiveIndexNode 0}}"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "290"
  wait: true

############## Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "440"
  wait: true

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true




###############  Rebalance-in single node and stop rebalance ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "310"
  wait: true

- template: rebalance_stop

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "310"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

- template: rebalance

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1040000  --end 1050000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1040000  --end 1050000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1040001 --end 1050000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1040001 --end 1050000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1040001 --end 1050000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r2
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1040001 --end 1050000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r2
  wait: true

- client:
    op: rm
    container: vector_mutations_1r2
- client:
    op: rm
    container: vector_mutations_2r2
- client:
    op: rm
    container: vector_mutations_3r2
- client:
    op: rm
    container: vector_mutations_4r2
- client:
    op: rm
    container: vector_mutations_5r2
- client:
    op: rm
    container: vector_mutations_6r2
- client:
    op: rm
    container: vector_mutations_7r2
- client:
    op: rm
    container: vector_mutations_8r2

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

######## Validations #######################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true


###############  Rebalance-out single index node and stop rebalance ################
- template: rebalance_out
  args: "{{.ActiveIndexNode 0}}"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "324"
  wait: true

- template: rebalance_stop

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "326"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

- template: rebalance

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --mutate true --mutation_duration 3600"
  alias: vector_mutations_1a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_4a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Swap single index node ################
- template: rebalance_swap
  args: "{{.InActiveNode}}, {{.ActiveIndexNode 0}}, index"

# Sleep after starting rebalance
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "902"
  wait: true

############### Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "903"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "509"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Complete the rebalance ################
- template: rebalance

- template: wait_for_rebalance
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 2}}, memcached"

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "612"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

###############  Rebalance-in a index nodes ################
- template: add_node
  args: "{{.NthInActiveNode 0}}, index"
- template: rebalance

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "417"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "619"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

###############  Rebalance-out two index nodes ################
- template: rebalance_out
  args: "({{.ActiveIndexNode 0}},{{.ActiveIndexNode 2}})"


# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "432"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "611"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

############ mutate vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --mutate true --mutation_duration 3600"
  alias: vector_mutations_1a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1 --end 1000000 --batch_size 100000 --file_path /sift_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_4a
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1 --end 1000000 --batch_size 100000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0 --mutate true --mutation_duration 3600"
  alias: vector_mutations_5a

####### mutate scalar fields #######################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1  --end 100000 --doc_template Hotel --all_coll true  --mutations_mode true --mutations_timeout 3600 --ops_rate 100"
  requires: "{{eq true .DoOnce }}"

###############  Rebalance-in two index nodes ################
- template: add_node
  args: "{{.NthInActiveNode 0}}, index"
- args: "{{.NthInActiveNode 1}}, index"
- template: rebalance

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "417"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "619"
  wait: true

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1050000  --end 1060000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1050000  --end 1060000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1050001 --end 1060000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1050001 --end 1060000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1050001 --end 1060000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r3
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1050001 --end 1060000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r3
  wait: true


- client:
    op: rm
    container: vector_mutations_1r3
- client:
    op: rm
    container: vector_mutations_2r3
- client:
    op: rm
    container: vector_mutations_3r3
- client:
    op: rm
    container: vector_mutations_4r3
- client:
    op: rm
    container: vector_mutations_5r3
- client:
    op: rm
    container: vector_mutations_6r3
- client:
    op: rm
    container: vector_mutations_7r3
- client:
    op: rm
    container: vector_mutations_8r3

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

######## Validate items count against KV #######################

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a post_topology_change_validations"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true

############## Kill projector ################
- template: kill_process
  args: "{{.NthDataNode 0}}, projector"

# Sleep for some more time after projector-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "605"
  wait: true

############## Kill query ################
- template: kill_process
  args: "{{.Nodes | .Service `n1ql` | net 1}}, cbq-engine"

# Sleep for some more time after query-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "609"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"
  wait: true

###############  Rebalance out data node ################
- template: rebalance_out
  args: "({{.NthDataNode 1}})"
  wait: true
# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "298"
  wait: true

############## Kill memcached ################
- template: kill_process
  args: "{{.NthDataNode 2}}, memcached"

# Sleep for some more time after memcached-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "614"
  wait: true

###############  Add back data node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, data"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "315"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"

# Sleep for some more time after indexer-kill completes (30 minutes)
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Failover and addback ################
- template: failover_force_and_recover
  args: "{{.ActiveIndexNode 2}}, full"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "304"
  wait: true

############## Kill query ################
- template: kill_process
  args: "{{.Nodes | .Service `n1ql` | net 0}}, cbq-engine"

# Sleep for some more time after query-kill completes (10 minutes)
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "615"
  wait: true

############## Kill indexer ################
- template: kill_process
  args: "{{.ActiveIndexNode 0}}, indexer"

# Sleep for some more time after indexer-kill completes (10 minutes)
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a wait_until_rebalance_cleanup_done"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

###############  Failover index node and rebalance out ################
- template: hard_failover_node
  args: "{{.ActiveIndexNode 1}}"
  wait: true

- template: rebalance
  wait: true
# Sleep for some time to allow DDL to complete if running in background.
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "299"
  wait: true

###############  Add back index node  ################
- template: add_node
  args: "{{.NthInActiveNode 0}}, index"
  wait: true

- template: rebalance

- template: wait_for_rebalance
  wait: true
# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "289"
  wait: true

###############  Auto failover for indexer node ################
- template: autofailover1IndexNode
  args: "{{.ActiveIndexNode 1}}"
  wait: true

- section_end: change_indexer_topologies_file_based

############### more data loading ################
- image: sequoiatools/magmaloader:dev
  command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.Bucket}} --start 1060000  --end 1070000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true
- command: "--host {{.Orchestrator}} --user Administrator --password password --bucket {{.NthBucket 1}} --start 1060000  --end 1070000 --doc_template Hotel --all_coll true"
  requires: "{{eq true .DoOnce }}"
  wait: true

############ more vector embeddings ################
- image: sequoiatools/siftloader
  command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1060001 --end 1070000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false"
  alias: vector_mutations_1r7
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1060001 --end 1070000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false"
  alias: vector_mutations_2r7
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.Bucket}} --start 1060001 --end 1070000 --batch_size 1000 --file_path /siftsmall_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_4r7
  wait: true
- command: "--connection_string {{.Orchestrator}} --username Administrator --password password --bucket {{.NthBucket 1}} --start 1060001 --end 1070000 --batch_size 1000 --file_path /gist_base.fvecs --load_in_chunks false --scope scope_0 --collection coll_0"
  alias: vector_mutations_5r7
  wait: true

- client:
    op: rm
    container: vector_mutations_1r7
- client:
    op: rm
    container: vector_mutations_2r7
- client:
    op: rm
    container: vector_mutations_3r7
- client:
    op: rm
    container: vector_mutations_4r7
- client:
    op: rm
    container: vector_mutations_5r7
- client:
    op: rm
    container: vector_mutations_6r7
- client:
    op: rm
    container: vector_mutations_7r7
- client:
    op: rm
    container: vector_mutations_8r7

############### KV node failover/recovery ###############
- template: failover_and_recover
  args: "{{.ActiveDataNode 2}}, full"
  wait: true

###############  Complete the rebalance ################
- template: wait_for_rebalance
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "543"
  wait: true

###############  Hard failover KV node and rebalance out ################
- template: hard_failover_node
  args: "{{.ActiveDataNode 2}}"
  wait: true

###############  Complete the rebalance ################
- template: rebalance

- template: wait_for_rebalance
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "332"
  wait: true

# ###############  Rebalance in a KV node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, data"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "534"
  wait: true

# ###############  Rebalance out an Index node ################
- template: rebalance_out
  args: "({{.ActiveIndexNode 1}})"
  wait: true

# Sleep for some more time after rebalance completes
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "298"
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

############### Start creating indexes in a loop on bucket4 & bucket5 (Collection CRUD workload) ###############
- section_start: create_replica_indexes
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -i {{.Scale 1}} -a create_index -v"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}} -a build_deferred_index -m 5"
  wait: true

- section_start: create_replica_indexes
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -i {{.Scale 1}} -a create_index -v"
  wait: true

- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a build_deferred_index -m 5"
  wait: true


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a build_deferred_index -m 5"
  wait: true


- image: sequoiatools/wait_for_idx_build_complete
  command: "{{.ActiveIndexNode 0}} {{.RestUsername}} {{.RestPassword}}"
  wait: true

# Sleep for some time
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

######## Check for item count match #######################
######## Validate items count against KV #######################

- image: sequoiatools/indexmanager
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a item_count_check --sample_size 5 --all_docs_indexed true"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true
- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a item_count_check --dataset shoes --sample_size 5 --all_docs_indexed true"
  wait: true


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -a wait_until_mutations_processed --timeout 18000 --bucket_list {{.NthBucket 1}},{{.NthBucket 5}},{{.NthBucket 8}}"
  wait: true


- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true

# change the topologies on the query nodes
- test: tests/2i/neo/test_idx_neo_integration.yml
  section: change_query_topologies

############### Stop Data loading to cool down system for item count check ###############
- client:
    op: rm
    container: collection_bucket1_doc_ops1
- client:
    op: rm
    container: collection_bucket2_doc_ops1
- client:
    op: rm
    container: collection_bucket3_doc_ops1
- client:
    op: rm
    container: collection_bucket1_doc_ops2
- client:
    op: rm
    container: collection_bucket2_doc_ops2
- client:
    op: rm
    container: collection_bucket3_doc_ops2
- client:
    op: rm
    container: collection_bucket1_doc_ops3
- client:
    op: rm
    container: collection_bucket2_doc_ops3
- client:
    op: rm
    container: collection_bucket3_doc_ops3
- client:
    op: rm
    container: collection_bucket1_doc_ops4
- client:
    op: rm
    container: collection_bucket2_doc_ops4
- client:
    op: rm
    container: collection_bucket3_doc_ops4
- client:
    op: rm
    container: cbo_bucket1
- client:
    op: rm
    container: cbo_bucket2
- client:
    op: rm
    container: cbo_bucket3
- client:
    op: rm
    container: query_workload_1
- client:
    op: rm
    container: query_workload_2
- client:
    op: rm
    container: query_workload_3
- client:
    op: rm
    container: query_workload_4
- client:
    op: rm
    container: query_workload_5
- client:
    op: rm
    container: query_workload_6

- client:
    op: rm
    container: query_workload_7
- client:
    op: rm
    container: query_workload_8
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "300"
  wait: true

###############  Delete Statistics ################
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}}  -a delete_statistics"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}}  -a delete_statistics"
  wait: true


###############  Rebalance-in single node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "430"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

###############  Rebalance-out single node ################
- template: rebalance_out
  args: "({{.ActiveIndexNode 1}})"
  wait: true

# Sleep before starting to poll for rebalance progress
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "430"
  wait: true

# Wait for rebalance to complete
- template: wait_for_rebalance
  wait: true

###############  run queries ################
- section_start: query_vector_indexes
- image: sequoiatools/query_manager:dev
  command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list {{.Bucket}} --distance_algo EUCLIDEAN_SQUARED --use_tls false"
  alias: query_workload_1
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 60 --use_sdk true --query_type n1ql --template hotel,hotel_vectors --bucket_list  {{.NthBucket 1}} --distance_algo DOT --num_query_vectors 1000 --num_groundtruth_vectors 100 --query_file /gist_query.fvecs --groundtruth_file /gist_groundtruth.ivecs --use_tls false"
  alias: query_workload_2

- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 8}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_8
- command: "--connection_string {{.Orchestrator}} --username {{.RestUsername}} --password {{.RestPassword}} --action run_query_workload --duration 7200 --refresh_duration 900 --timeout 3600 --num_concurrent_queries 6 --use_sdk true --query_type n1ql --template shoes_50M --bucket_list  {{.NthBucket 5}} --distance_algo L2 --num_query_vectors 10000 --num_groundtruth_vectors 1000 --query_file /bigann_query.bvecs --validate_vector_query_results true --use_tls false --skip_default false --run_bhive_queries true"
  alias: query_workload_6
- section_end: query_vector_indexes

###############  Drop all Indexes ################
- section_start: drop_all_indexes
- image: sequoiatools/indexmanager
  command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.Bucket}}  -a drop_all_indexes -v"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 1}} -a drop_all_indexes -v"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 3}} -a drop_all_indexes -v"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 5}} -a drop_all_indexes -v"
  wait: true

- command: "-n {{.Orchestrator}} -o {{.RestPort}} -u {{.RestUsername}} -p {{.RestPassword}} -b {{.NthBucket 8}} -a drop_all_indexes -v"
  wait: true


# Sleep for some time to allow DDL to complete in the background
- image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true
- section_end: drop_all_indexes
