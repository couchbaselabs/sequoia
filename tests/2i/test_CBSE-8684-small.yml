- include: tests/templates/kv.yml, tests/templates/n1ql.yml, tests/templates/rebalance.yml

############### update moi snapshot interval ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.settings.persisted_snapshot.moi.interval':180000"

############### update to use golang memory management, indexer config ################
- template: set_gsi_config
  args: "{{.ActiveIndexNode 0}}, 'indexer.moi.useMemMgmt':false"

############### data loading - load 1M docs with scale 1################
- image: sequoiatools/fakeit
  command: "couchbase --server {{.NthDataNode 1}}  --bucket {{.Bucket}} --username Administrator --password password --verbose --use-streams true --high-water-mark 512 --count {{.Scale 1000000}} /fakeit/test/fixtures/models/links/models/entity.yaml"

# Sleep for some time to allow some docs to be loaded
-
   image: sequoiatools/cmd
   entrypoint: sleep
   command: "600"
   wait: true


###############  create indexes ################
- section_start: create_replica_indexes
- image: sequoiatools/cbq
  command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='CREATE INDEX `snapshot_state_gtins_endDateTime_country_advertiseDateTime_class_PR_CL` ON `{{.Bucket}}`(`class`, (`entity`.`state`), (distinct (array `g` for `g` in ((`entity`.`cond`).`productG`) end)), (`entity`.`endDate`) DESC,((`entity`.`country`).`countryCode`), (`entity`.`advertdate`)) PARTITION BY hash(`aggId`) WHERE (`class` in [\"promotionsnapshot\", \"clearancesnapshot\"]) WITH { \"num_partition\":6 }'"
  wait: true
- command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='CREATE INDEX `snapshot_state_subcondition_gtins_endDateTime_country_advertiseDateTime_class_PR_CL` ON `{{.Bucket}}`(`class`, (`entity`.`state`), (distinct (array (distinct (array `gtin` for `gtin` in (`subCond`.`productG`) end)) for `subCond` in ((`entity`.`cond`).`subConds`) end)), (`entity`.`endDate`) DESC,((`entity`.`country`).`countryCode`), (`entity`.`advertdate`)) PARTITION BY hash(`aggId`) WHERE (`class` in [\"promotionsnapshot\", \"clearancesnapshot\"]) WITH { \"num_partition\":6 }'"
  wait: true

# Wait till all indexes are completely built
-
  image: sequoiatools/wait_for_idx_build_complete
  command: "{{.ActiveIndexNode 0}} {{.RestUsername}} {{.RestPassword}}"
  wait: true

- section_end: create_replica_indexes

# ###############  run queries for 12 hrs for scale 1 ################
- section_start: query_replica_indexes
- image: sequoiatools/queryapp
  command: "-J-cp /AnalyticsQueryApp/Couchbase-Java-Client-2.5.6/* /AnalyticsQueryApp/Query/load_queries.py --server_ip {{.Nodes | .Service `n1ql` | net 0}} --port {{.QueryPort}} --duration {{.Scale 43200}} --print_duration=600 --bucket {{.Bucket}} --querycount 3 --threads 3 --n1ql True --query_file cbse-8684_queries.txt --query_timeout=1200 --bucket_names [{{.Bucket}}]"
  wait: true


- section_end: query_replica_indexes



